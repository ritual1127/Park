<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#007aff">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>성적 계산기 (PWA)</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f2f2f7; --fg: #1c1c1e;
      --box-bg: rgba(255,255,255,0.9);
      --inp-bg: #fff; --inp-border: #d0d6db;
      --primary: #007aff;
      --card-shadow: 0 6px 18px rgba(16,24,40,0.08);
    }
    [data-theme="dark"] {
      --bg: #0b0b0d; --fg: #f2f2f7;
      --box-bg: rgba(28,28,30,0.85);
      --inp-bg: #131313; --inp-border: #2a2a2c;
      --primary: #0a84ff;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, rgba(255,255,255,0.6) 100%);
      color: var(--fg);
      max-width: 540px; margin: 20px auto; padding: env(safe-area-inset-top) 18px 40px;
      -webkit-font-smoothing:antialiased;
    }
    .container { display: grid; gap: 18px; }
    .top-bar { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title { display:flex; align-items:center; gap:12px; }
    .logo { width:46px; height:46px; border-radius:10px; background:var(--primary); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:20px; box-shadow: var(--card-shadow); }
    h1 { font-size:20px; margin:0; }
    .subtitle { font-size:12px; color: #6b6b70; margin-top:4px; }
    .box {
      background: var(--box-bg); border-radius:14px; padding:16px; box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.4);
    }
    .entry { display:grid; grid-template-columns:110px 1fr; gap:8px; align-items:center; margin-bottom:12px; }
    .entry label { color:#6b6b70; font-size:14px; }
    .entry input[type="text"], .entry input[type="number"], input[type="date"] {
      height:44px; padding:0 12px; border-radius:10px; border:1px solid var(--inp-border);
      background:var(--inp-bg); color:var(--fg); font-size:15px;
    }
    .count-container { display:flex; gap:12px; }
    .count-container .half { flex:1; }
    .small { font-size:13px; color:#8b8b90; }
    .btn { display:block; width:100%; height:46px; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; border:none; cursor:pointer; box-shadow: 0 6px 14px rgba(0,122,255,0.12); }
    #result { text-align:center; font-size:16px; padding:8px 0; }
    .history-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .table-container { overflow-x:auto; border-radius:10px; }
    .record-table { width:100%; border-collapse:collapse; font-size:13px; }
    .record-table th, .record-table td { padding:10px 8px; text-align:center; }
    .record-table tbody tr td.subject { text-align:left; padding-left:16px; }
    .record-table tbody tr:nth-child(even) td { background: #f7f7fa; }
    .delete-btn { color:#ff3b30; cursor:pointer; }
    .info-btn { background:transparent; border:1px solid var(--primary); color:var(--primary); padding:6px 8px; border-radius:8px; cursor:pointer; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; padding:20px; z-index:1000; }
    .modal-content { width:100%; max-width:520px; background:var(--box-bg); border-radius:12px; padding:18px; }
    footer { text-align:center; color:#9b9b9f; font-size:13px; margin-top:8px; }
    @media (max-width:420px){ .entry { grid-template-columns: 1fr; } .title h1{ font-size:18px;} }
  </style>
</head>
<body data-theme="light">
  <div class="container">
    <div class="top-bar">
      <div class="title">
        <div class="logo">성</div>
        <div>
          <h1>성적 계산기</h1>
          <div class="subtitle">간편하고 빠른 등급 계산</div>
        </div>
      </div>
      <div>
        <button id="themeToggle" class="info-btn">다크 모드</button>
      </div>
    </div>

    <div class="box">
      <div class="entry">
        <label for="subjectName">과목명</label>
        <input type="text" id="subjectName" placeholder="예: 수학">
      </div>
      <div id="countBox" class="count-container">
        <div class="half">
          <label class="small">수행평가 개수</label>
          <input type="number" id="sCount" value="2" min="1" onchange="generateInputs()">
        </div>
        <div class="half">
          <label class="small">지필평가 개수</label>
          <input type="number" id="tCount" value="2" min="1" max="2" onchange="generateInputs()">
        </div>
      </div>
    </div>

    <div id="inputs" class="box"></div>

    <button id="calcBtn" class="btn">계산하기</button>
    <div id="result" class="box" style="text-align:center;">결과가 여기에 표시됩니다.</div>

    <div class="box" id="history">
      <div class="history-header">
        <strong>계산 기록</strong>
        <button id="resetBtn" class="info-btn">기록 삭제</button>
      </div>
      <div class="table-container">
        <table class="record-table">
          <thead><tr><th>일시</th><th>과목</th><th>최종점수</th><th>등급</th><th>올라갈 기준</th><th>떨어질 기준</th><th>삭제</th><th>정보</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <footer>오프라인에서도 작동(간단 캐시). 홈 화면에 추가해 앱처럼 사용하세요.</footer>
  </div>

  <div id="detailModal" class="modal"><div class="modal-content"><button id="modalCloseBtn" class="info-btn" style="float:right;">닫기</button><div id="modalInnerContent"></div></div></div>

<script>
/* PWA: register service worker */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}

/* Theme */
const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
const themeToggle = document.getElementById('themeToggle');
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  themeToggle.textContent = theme === 'dark' ? '라이트 모드' : '다크 모드';
  localStorage.setItem('theme', theme);
}
const savedTheme = localStorage.getItem('theme');
const initTheme = savedTheme || (mediaQuery.matches ? 'dark' : 'light');
applyTheme(initTheme);
mediaQuery.addEventListener('change', e => { if (!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light'); });
themeToggle.onclick = () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');

/* Inputs generator */
function generateInputs(){
  const sCnt = +document.getElementById('sCount').value;
  const tCnt = +document.getElementById('tCount').value;
  let html = '<h3 style="margin:0 0 10px 0;">수행평가</h3>';
  for(let i=0;i<sCnt;i++){
    html += `<div class="entry"><label>수행${i+1}</label><input type="number" id="s${i}" placeholder="점수"><label>비중(%)</label><input type="number" id="sw${i}" placeholder="%"></div>`;
  }
  html += '<h3 style="margin:8px 0 10px 0;">지필평가</h3>';
  for(let i=0;i<tCnt;i++){
    const lbl = tCnt===1 ? '기말고사' : (i===0 ? '중간고사' : '기말고사');
    html += `<div class="entry"><label>${lbl}</label><input type="number" id="t${i}" placeholder="점수"><label>비중(%)</label><input type="number" id="tw${i}" placeholder="%"></div>`;
  }
  document.getElementById('inputs').innerHTML = html;
}

/* History storage */
function loadHistory(){ return JSON.parse(localStorage.getItem('gradeHistory') || '[]'); }
function saveHistory(entry){ const h = loadHistory(); h.unshift(entry); localStorage.setItem('gradeHistory', JSON.stringify(h.slice(0,50))); }
function deleteHistory(i){ const h = loadHistory(); h.splice(i,1); localStorage.setItem('gradeHistory', JSON.stringify(h)); renderHistory(); }

function renderHistory(){
  const tb = document.getElementById('historyBody'); tb.innerHTML='';
  loadHistory().forEach((it,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.time}</td><td class="subject">${it.subject}</td><td>${it.final}</td><td><strong>${it.grade}</strong></td><td>${it.nextMsg}</td><td>${it.dropMsg}</td><td><div class="delete-btn" onclick="deleteHistory(${i})">삭제</div></td><td><button class="info-btn" data-idx="${i}">정보</button></td>`;
    tb.appendChild(tr);
  });
  document.querySelectorAll('.info-btn').forEach(b => b.onclick = ()=> showInfo(+b.dataset.idx) );
}

/* Modal */
const modal = document.getElementById('detailModal'), inner = document.getElementById('modalInnerContent');
document.getElementById('modalCloseBtn').onclick = () => modal.style.display = 'none';
window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

/* Edit subject */
function updateSubjectName(idx){
  const list = loadHistory();
  const newName = document.getElementById('editSubject').value.trim();
  if (!newName) return alert('과목명을 입력하세요.');
  list[idx].subject = newName;
  localStorage.setItem('gradeHistory', JSON.stringify(list));
  modal.style.display = 'none'; renderHistory();
}

/* Show info */
function showInfo(idx){
  const e = loadHistory()[idx]; if(!e) return;
  inner.innerHTML = `<h2>과목명 수정</h2><input id="editSubject" value="${e.subject}" style="width:100%; padding:8px; font-size:16px; margin-bottom:12px;"><h3>수행평가</h3><div class="table-group"><table style="width:100%"><thead><tr><th>회차</th><th>점수</th><th>비중</th></tr></thead><tbody>${e.performances.map((p,i)=>`<tr><td>${i+1}</td><td>${p.score}</td><td>${p.weight}%</td></tr>`).join('')}</tbody></table></div><h3>지필평가</h3><div class="table-group"><table style="width:100%"><thead><tr><th>구분</th><th>점수</th><th>비중</th></tr></thead><tbody>${e.exams.map(ex=>`<tr><td>${ex.label}</td><td>${ex.score}</td><td>${ex.weight}%</td></tr>`).join('')}</tbody></table></div><button class="btn" onclick="updateSubjectName(${idx})">저장</button>`;
  modal.style.display = 'flex';
}

/* Calculation */
function calculate(){
  const subj = document.getElementById('subjectName').value.trim() || '-';
  const sCnt = +document.getElementById('sCount').value, tCnt = +document.getElementById('tCount').value;
  let sSum=0, tSum=0, wSum=0, mid=0, finalW=0; const perf=[], exms=[];
  for(let i=0;i<sCnt;i++){ const sc=+document.getElementById(`s${i}`).value||0, w=+document.getElementById(`sw${i}`).value||0; perf.push({score:sc,weight:w}); sSum+=sc*(w/100); wSum+=w; }
  for(let i=0;i<tCnt;i++){ const sc=+document.getElementById(`t${i}`).value||0, w=+document.getElementById(`tw${i}`).value||0, lbl=(tCnt===1?'기말고사':i===0?'중간고사':'기말고사'); exms.push({label:lbl,score:sc,weight:w}); if(tCnt===1||i===tCnt-1) finalW=w/100; else mid+=sc*(w/100); tSum+=sc*(w/100); wSum+=w; }
  if(wSum!==100){ document.getElementById('result').textContent = `❗ 총 비중이 100%가 아닙니다 (현재 ${wSum}%).`; return; }
  const final = +(sSum+tSum).toFixed(2), grade=final>=90?'A':final>=80?'B':final>=70?'C':final>=60?'D':'E';
  const nextTh={A:null,B:90,C:80,D:70,E:60}[grade], currTh={A:90,B:80,C:70,D:60,E:0}[grade];
  let nextMsg='최고 등급!'; if(nextTh){ const need=(nextTh-sSum-mid)/finalW, nG={90:'A',80:'B',70:'C',60:'D'}[nextTh]; nextMsg = need>100?`${nG} 등급 불가`:`${nG} 위해 ${need.toFixed(2)}점↑`; }
  const drop=(currTh-0.01-sSum-mid)/finalW, dropMsg = drop<0 ? '떨어질 등급 없음' : `${drop.toFixed(2)}점↓ (이하 ${ {90:'B',80:'C',70:'D',60:'E'}[currTh] })`;
  document.getElementById('result').innerHTML = `최종: <strong>${final}점</strong><br>${grade} 등급<br>${nextMsg}<br>${dropMsg}`;
  const now=new Date(); const time=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  saveHistory({time, subject:subj, final, grade, nextMsg, dropMsg, performances:perf, exams:exms}); renderHistory();
}

document.getElementById('calcBtn').onclick = calculate;
document.getElementById('resetBtn').onclick = ()=>{ if(!confirm('기록을 모두 삭제하시겠습니까?')) return; localStorage.removeItem('gradeHistory'); renderHistory(); };

/* Init */
generateInputs(); renderHistory();
</script>
</body>
</html>
