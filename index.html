<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ì„±ì ê³„ì‚°ê¸°">
<meta name="theme-color" content="#007aff">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<title>ì„±ì  ê³„ì‚°ê¸° with ê¸‰ì‹</title>

<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg:#f4f5f7;
  --fg:#1c1c1e;
  --card:#ffffffcc;
  --border:#d0d6db;
  --primary:#007aff;
  --footer-text:#8c8c91;
  --meal-breakfast:#ff9500;
  --meal-lunch:#34c759;
  --meal-dinner:#5856d6;
}

[data-theme="dark"] {
  --bg:#0c0c0e;
  --fg:#e9e9ec;
  --card:#1c1c1ecc;
  --border:#333;
  --primary:#0a84ff;
  --footer-text:#6e6e73;
}

body {
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background:var(--bg);
  color:var(--fg);
  padding:30px 20px 60px;
  padding-top: max(30px, env(safe-area-inset-top));
  padding-bottom: max(60px, env(safe-area-inset-bottom));
  padding-left: max(20px, env(safe-area-inset-left));
  padding-right: max(20px, env(safe-area-inset-right));
  max-width:550px;
  margin:auto;
  min-height: 100vh;
}

.install-banner {
  display: none;
  background: linear-gradient(135deg, var(--primary), #5856d6);
  color: white;
  padding: 14px 18px;
  border-radius: 14px;
  margin-bottom: 20px;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.install-banner.show {
  display: flex;
}

.install-text {
  flex: 1;
}

.install-title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 2px;
}

.install-desc {
  font-size: 12px;
  opacity: 0.9;
}

.install-btn {
  padding: 8px 14px;
  background: white;
  color: var(--primary);
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
}

.install-close {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  opacity: 0.8;
  padding: 0 4px;
}

.box {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:18px;
  backdrop-filter:blur(18px);
  margin-top:20px;
}

.meal-box {
  background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(0, 122, 255, 0.1));
  border: 2px solid var(--meal-lunch);
  position: relative;
  overflow: hidden;
}

.meal-box::before {
  content: 'ğŸ´';
  position: absolute;
  top: -10px;
  right: -10px;
  font-size: 80px;
  opacity: 0.1;
}

.meal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.meal-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--meal-lunch);
}

.meal-date {
  font-size: 13px;
  color: #808088;
}

.meal-type-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
}

.meal-tab {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg);
  cursor: pointer;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
}

.meal-tab.active {
  background: var(--meal-lunch);
  color: white;
  border-color: var(--meal-lunch);
}

.meal-tab.breakfast.active {
  background: var(--meal-breakfast);
  border-color: var(--meal-breakfast);
}

.meal-tab.dinner.active {
  background: var(--meal-dinner);
  border-color: var(--meal-dinner);
}

.meal-content {
  background: var(--card);
  padding: 15px;
  border-radius: 12px;
  min-height: 120px;
}

.meal-menu {
  line-height: 1.8;
  font-size: 15px;
}

.meal-menu-item {
  padding: 6px 0;
  border-bottom: 1px dashed var(--border);
}

.meal-menu-item:last-child {
  border-bottom: none;
}

.meal-loading {
  text-align: center;
  padding: 30px;
  color: #808088;
}

.meal-empty {
  text-align: center;
  padding: 30px;
  color: #808088;
}

.meal-settings-btn {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--meal-lunch);
  background: transparent;
  color: var(--meal-lunch);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

.notification-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  background: var(--bg);
  border-radius: 10px;
  margin-top: 10px;
}

.notification-label {
  font-size: 14px;
  font-weight: 600;
}

.switch {
  position: relative;
  width: 50px;
  height: 28px;
  background: #ccc;
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.3s;
}

.switch.on {
  background: var(--meal-lunch);
}

.switch-knob {
  position: absolute;
  width: 24px;
  height: 24px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: all 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.switch.on .switch-knob {
  left: 24px;
}

.meal-allergy {
  font-size: 12px;
  color: #ff3b30;
  margin-top: 10px;
  padding: 8px;
  background: rgba(255, 59, 48, 0.1);
  border-radius: 8px;
}

.topbar {
  display:flex; justify-content:space-between; align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}
.logo {
  width:50px; height:50px; background:var(--primary);
  border-radius:12px; color:white; display:flex; justify-content:center; align-items:center;
  font-weight:800; font-size:22px;
}
.titlewrap { display:flex; gap:12px; align-items:center; }

.topbar-buttons {
  display: flex;
  gap: 8px;
}

.entry { margin-bottom:16px; }
.entry label { font-size:15px; color:#808088; margin-bottom:6px; display:block; }
.entry input {
  width:100%; height:46px; border-radius:10px;
  border:1px solid var(--border);
  padding:0 12px; font-size:16px;
  background:var(--bg); color:var(--fg);
}

.section-title {
  font-size:17px; font-weight:600; margin-bottom:10px;
}

.weight-select { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.weight-btn {
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--bg);
  cursor:pointer; font-size:14px;
  color: var(--fg);
}
.weight-btn.active {
  background:var(--primary);
  color:white;
  border-color:var(--primary);
}

.custom-weight-container { display:none; gap:8px; margin-top:10px; }
.custom-weight-input {
  flex:1; height:40px;
  border-radius:10px; border:1px solid var(--border);
  padding:0 10px; background:var(--bg); color:var(--fg);
}
.weight-set-btn {
  padding:0 14px;
  border-radius:10px; border:none;
  background:var(--primary); color:white;
  font-weight:600;
  cursor: pointer;
}

.btn {
  width:100%; height:48px; border:none;
  border-radius:12px; background:var(--primary); color:white;
  font-size:17px; font-weight:700; margin-top:14px;
  cursor: pointer;
}

.table-wrap { margin-top:10px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th {
  padding:10px 6px; color:#999; font-weight:600; white-space:nowrap;
}
td {
  padding:10px 6px; text-align:center; white-space:nowrap;
}
td.subject { text-align:left; padding-left:10px; }
tr:nth-child(even) td { background:rgba(255,255,255,0.05); }

.delete-btn { color:#ff3b30; font-weight:600; cursor:pointer; }
.info-btn {
  padding:4px 8px; border-radius:8px; border:1px solid var(--primary);
  background:transparent; color:var(--primary); cursor:pointer;
}

.modal {
  position:fixed; inset:0; background:rgba(0,0,0,0.45);
  display:none; justify-content:center; align-items:center; padding:20px;
  z-index: 1000;
}
.modal-content {
  background:var(--card);
  padding:18px; border-radius:16px; width:100%; max-width:480px;
  max-height: 90vh;
  overflow-y: auto;
  backdrop-filter:blur(18px);
}

#result {
  margin-top:10px;
  text-align:center; line-height:1.6; font-size:17px;
}

.grade-A { color: #34c759; font-weight: 700; }
.grade-B { color: #30d158; font-weight: 700; }
.grade-C { color: #ff9f0a; font-weight: 700; }
.grade-D { color: #ff9500; font-weight: 700; }
.grade-E { color: #ff3b30; font-weight: 700; }

.count-row {
  display:flex;
  gap:16px;
}
.count-row .entry {
  flex:1;
}

.subject-guide-btn {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--fg);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 12px;
}
.subject-guide-btn:hover {
  background: var(--card);
}

.guide-table {
  width: 100%;
  margin-top: 15px;
  font-size: 14px;
}
.guide-table th {
  background: var(--bg);
  padding: 10px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid var(--border);
}
.guide-table td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
}
.guide-table tr:hover td {
  background: var(--bg);
  cursor: pointer;
}
.guide-subject {
  font-weight: 600;
  color: var(--primary);
}

.star-rating {
  display: inline-flex;
  gap: 8px;
  font-size: 36px;
  cursor: pointer;
}
.star {
  color: #d0d6db;
  transition: all 0.2s ease;
  user-select: none;
}
.star:hover,
.star.active {
  color: #ffd700;
  transform: scale(1.1);
}

.footer {
  text-align: center;
  margin-top: 40px;
  padding: 20px 0;
  font-size: 13px;
  color: var(--footer-text);
  font-weight: 500;
  line-height: 1.8;
}
.footer a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}
.footer a:hover {
  text-decoration: underline;
}

.prediction-box {
  margin-top: 15px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(0,122,255,0.1), rgba(52,199,89,0.1));
  border-radius: 12px;
  border: 1px dashed var(--primary);
}

.prediction-title {
  font-size: 14px;
  color: var(--primary);
  font-weight: 600;
  margin-bottom: 8px;
}

.theme-icon-btn {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--bg);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
}

.theme-icon-btn:active {
  transform: scale(0.9);
  background: var(--border);
}

.theme-icon {
  width: 28px;
  height: 28px;
  color: var(--fg);
}

.avg-calc-btn {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid #34c759;
  background: transparent;
  color: #34c759;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}
.avg-calc-btn:hover {
  background: #34c759;
  color: white;
}

.avg-modal-content {
  background: var(--bg);
  padding: 24px;
  border-radius: 16px;
  width: 100%;
  max-width: 500px;
  max-height: 85vh;
  overflow-y: auto;
}

.avg-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.avg-header h2 {
  font-size: 20px;
  font-weight: 700;
}

.avg-close-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: var(--border);
  color: var(--fg);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avg-step {
  margin-bottom: 20px;
}

.avg-step-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--primary);
}

.avg-input {
  width: 100%;
  height: 46px;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 0 12px;
  font-size: 16px;
  background: var(--card);
  color: var(--fg);
}

.avg-subjects-container {
  display: none;
}

.avg-subject-row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
  align-items: center;
}

.avg-subject-row input {
  flex: 1;
  height: 42px;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 0 12px;
  font-size: 15px;
  background: var(--card);
  color: var(--fg);
}

.avg-next-btn {
  width: 100%;
  height: 46px;
  border: none;
  border-radius: 12px;
  background: var(--primary);
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

.avg-result {
  display: none;
  text-align: center;
  padding: 20px;
  background: linear-gradient(135deg, rgba(52,199,89,0.15), rgba(0,122,255,0.15));
  border-radius: 12px;
  margin-top: 15px;
}

.avg-result-score {
  font-size: 48px;
  font-weight: 800;
  color: var(--primary);
}

.avg-result-label {
  font-size: 14px;
  color: #808088;
  margin-top: 5px;
}

.avg-subject-list {
  margin-top: 15px;
  text-align: left;
  font-size: 14px;
}

.avg-subject-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.school-search-container {
  margin-bottom: 15px;
}

.school-search-input {
  width: 100%;
  height: 46px;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 0 12px;
  font-size: 16px;
  background: var(--card);
  color: var(--fg);
  margin-bottom: 10px;
}

.school-results {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--card);
}

.school-item {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.2s;
}

.school-item:hover {
  background: var(--bg);
}

.school-item:last-child {
  border-bottom: none;
}

.school-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.school-address {
  font-size: 12px;
  color: #808088;
}

.current-school {
  padding: 12px;
  background: var(--bg);
  border-radius: 10px;
  margin-bottom: 15px;
}

.current-school-label {
  font-size: 12px;
  color: #808088;
  margin-bottom: 4px;
}

.current-school-name {
  font-weight: 600;
  font-size: 15px;
}
</style>

</head>
<body data-theme="light">

<div id="installBanner" class="install-banner">
  <div class="install-text">
    <div class="install-title">í™ˆ í™”ë©´ì— ì¶”ê°€</div>
    <div class="install-desc">ì•±ì²˜ëŸ¼ ë¹ ë¥´ê²Œ ì‚¬ìš©í•˜ì„¸ìš”</div>
  </div>
  <button class="install-btn" onclick="installApp()">ì„¤ì¹˜</button>
  <button class="install-close" onclick="closeInstallBanner()">Ã—</button>
</div>

<div class="topbar">
  <div class="titlewrap">
    <div class="logo">ì„±</div>
    <div>
      <div style="font-size:20px; font-weight:700;">ì„±ì  ê³„ì‚°ê¸°</div>
      <div style="font-size:13px; color:#8c8c91;">ë” í¸í•˜ê²Œ ê³„ì‚°í•´ìš”</div>
    </div>
  </div>
  <div class="topbar-buttons">
    <button class="avg-calc-btn" onclick="openAvgCalc()">í‰ê·  ê³„ì‚°ê¸°</button>
    <button id="themeToggle" class="theme-icon-btn">
      <svg class="theme-icon" viewBox="0 0 100 100" fill="currentColor">
        <rect x="46" y="5" width="8" height="15" rx="4" />
        <rect x="46" y="80" width="8" height="15" rx="4" />
        <rect x="5" y="46" width="15" height="8" rx="4" />
        <rect x="80" y="46" width="15" height="8" rx="4" />
        <rect x="17" y="17" width="8" height="15" rx="4" transform="rotate(45 21 24.5)" />
        <rect x="75" y="68" width="8" height="15" rx="4" transform="rotate(45 79 75.5)" />
        <rect x="17" y="68" width="8" height="15" rx="4" transform="rotate(-45 21 75.5)" />
        <rect x="75" y="17" width="8" height="15" rx="4" transform="rotate(-45 79 24.5)" />
        <circle cx="50" cy="50" r="25" fill="none" stroke="currentColor" stroke-width="8" />
        <path d="M55 35 Q42 50 55 65 Q65 50 55 35" />
      </svg>
    </button>
  </div>
</div>

<div class="box meal-box">
  <div class="meal-header">
    <div>
      <div class="meal-title">ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ê¸‰ì‹</div>
      <div class="meal-date" id="mealDate"></div>
    </div>
    <button class="meal-settings-btn" onclick="openMealSettings()">âš™ï¸ ì„¤ì •</button>
  </div>
  
  <div class="meal-type-tabs">
    <div class="meal-tab breakfast" onclick="changeMealType('breakfast')">ì¡°ì‹</div>
    <div class="meal-tab lunch active" onclick="changeMealType('lunch')">ì¤‘ì‹</div>
    <div class="meal-tab dinner" onclick="changeMealType('dinner')">ì„ì‹</div>
  </div>
  
  <div class="meal-content" id="mealContent">
    <div class="meal-loading">ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
  
  <div class="notification-toggle">
    <span class="notification-label">ğŸ“¢ ê¸‰ì‹ ì‹œê°„ ì•Œë¦¼</span>
    <div class="switch" id="notificationSwitch" onclick="toggleNotification()">
      <div class="switch-knob"></div>
    </div>
  </div>
</div>

<div class="box">
  <div class="entry">
    <label>ê³¼ëª©ëª…</label>
    <input id="subjectName" type="text" placeholder="ì˜ˆ: ìˆ˜í•™">
  </div>

  <div class="count-row">
    <div class="entry">
      <label>ìˆ˜í–‰í‰ê°€ ê°œìˆ˜</label>
      <input id="sCount" type="number" value="2" min="1" onchange="generateInputs()">
    </div>
    <div class="entry">
      <label>ì§€í•„í‰ê°€ ê°œìˆ˜</label>
      <input id="tCount" type="number" value="2" min="1" max="2" onchange="generateInputs()">
    </div>
  </div>

  <button class="subject-guide-btn" onclick="openGuide()">ê³¼ëª©ë³„ í¼ì„¼íŠ¸</button>
</div>

<div id="performBox" class="box"></div>
<div id="examBox" class="box"></div>

<button class="btn" onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>

<div id="result" class="box">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<div class="box">
  <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
    <strong>ê³„ì‚° ê¸°ë¡</strong>
    <button onclick="resetHistory()" class="info-btn">ì „ì²´ ë¦¬ì…‹</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ì¼ì‹œ</th>
          <th>ê³¼ëª©ëª…</th>
          <th>ìµœì¢…ì ìˆ˜</th>
          <th>ë“±ê¸‰</th>
          <th>ì˜¬ë¼ê°ˆ ê¸°ì¤€</th>
          <th>ë–¨ì–´ì§ˆ ê¸°ì¤€</th>
          <th>ì‚­ì œ</th>
          <th>ì •ë³´</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>
</div>

<div class="box">
  <div style="text-align:center;">
    <div style="font-size:17px; font-weight:600; margin-bottom:10px;">ì´ ì‚¬ì´íŠ¸ê°€ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?</div>
    <div class="star-rating">
      <span class="star" data-value="1">â˜†</span>
      <span class="star" data-value="2">â˜†</span>
      <span class="star" data-value="3">â˜†</span>
      <span class="star" data-value="4">â˜†</span>
      <span class="star" data-value="5">â˜†</span>
    </div>
    <div id="ratingResult" style="margin-top:10px; font-size:14px; color:#808088;"></div>
  </div>
</div>

<div id="mealSettingsModal" class="modal">
  <div class="modal-content">
    <button style="float:right;" class="info-btn" onclick="closeMealSettings()">ë‹«ê¸°</button>
    <h3 style="margin-bottom:15px;">ê¸‰ì‹ ì„¤ì •</h3>
    
    <div class="current-school" id="currentSchoolDisplay">
      <div class="current-school-label">í˜„ì¬ ì„¤ì •ëœ í•™êµ</div>
      <div class="current-school-name">í•™êµë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”</div>
    </div>
    
    <div class="school-search-container">
      <input type="text" class="school-search-input" id="schoolSearch" placeholder="í•™êµ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="searchSchool()" />
      <div class="school-results" id="schoolResults"></div>
    </div>
    
    <div class="entry">
      <label>ì¡°ì‹ ì•Œë¦¼ ì‹œê°„</label>
      <input type="time" id="breakfastTime" class="avg-input" value="08:00">
    </div>
    
    <div class="entry">
      <label>ì¤‘ì‹ ì•Œë¦¼ ì‹œê°„</label>
      <input type="time" id="lunchTime" class="avg-input" value="12:30">
    </div>
    
    <div class="entry">
      <label>ì„ì‹ ì•Œë¦¼ ì‹œê°„</label>
      <input type="time" id="dinnerTime" class="avg-input" value="18:00">
    </div>
    
    <button class="btn" onclick="saveMealSettings()">ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="detailModal" class="modal">
  <div class="modal-content">
    <button style="float:right;" class="info-btn" onclick="closeModal()">ë‹«ê¸°</button>
    <div id="modalInner"></div>
  </div>
</div>

<div id="guideModal" class="modal">
  <div class="modal-content">
    <button style="float:right;" class="info-btn" onclick="closeGuide()">ë‹«ê¸°</button>
    <h3 style="margin-bottom:15px;">ê³¼ëª©ë³„ ë¹„ì¤‘ ì•ˆë‚´</h3>
    <p style="font-size:13px; color:#808088; margin-bottom:10px;">ê³¼ëª©ëª…ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</p>
    <table class="guide-table">
      <thead>
        <tr>
          <th>ê³¼ëª©</th>
          <th>ìˆ˜í–‰í‰ê°€</th>
          <th>ì§€í•„í‰ê°€</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="guideTableBody"></tbody>
    </table>
    <button class="subject-guide-btn" style="margin-top:15px; background:var(--primary); color:white; border:none;" onclick="openAddSubject()">+ ìƒˆ ê³¼ëª© ì¶”ê°€</button>
  </div>
</div>

<div id="addSubjectModal" class="modal">
  <div class="modal-content" style="max-width:400px;">
    <button style="float:right;" class="info-btn" onclick="closeAddSubject()">ë‹«ê¸°</button>
    <h3 style="margin-bottom:15px;">ìƒˆ ê³¼ëª© ì¶”ê°€</h3>
    <div class="entry">
      <label>ê³¼ëª©ëª…</label>
      <input id="newSubjectName" type="text" placeholder="ì˜ˆ: ìˆ˜í•™">
    </div>
    <div class="entry">
      <label>ìˆ˜í–‰í‰ê°€ ê°œìˆ˜</label>
      <input id="newSCount" type="number" value="2" min="1" max="5" onchange="generateNewSubjectInputs()">
    </div>
    <div id="newSWeightsContainer"></div>
    <div class="entry">
      <label>ì§€í•„í‰ê°€ ê°œìˆ˜</label>
      <input id="newTCount" type="number" value="2" min="1" max="2" onchange="generateNewSubjectInputs()">
    </div>
    <div id="newTWeightsContainer"></div>
    <button class="btn" onclick="saveNewSubject()">ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="avgModal" class="modal">
  <div class="avg-modal-content">
    <div class="avg-header">
      <h2>í‰ê·  ê³„ì‚°ê¸°</h2>
      <button class="avg-close-btn" onclick="closeAvgCalc()">Ã—</button>
    </div>
    <div class="avg-step" id="avgStep1">
      <label style="font-size:14px; color:#808088; margin-bottom:8px; display:block;">ê³¼ëª© ê°œìˆ˜</label>
      <input type="number" id="avgSubjectCount" class="avg-input" placeholder="ê³¼ëª© ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”" min="1" max="20" onkeydown="handleAvgCountEnter(event)">
      <button class="avg-next-btn" onclick="generateAvgSubjects()">ë‹¤ìŒ</button>
    </div>
    <div class="avg-subjects-container" id="avgStep2">
      <label style="font-size:14px; color:#808088; margin-bottom:8px; display:block;">ê° ê³¼ëª© ì ìˆ˜ ì…ë ¥</label>
      <div id="avgSubjectsList"></div>
      <button class="avg-next-btn" onclick="calculateAvg()">í‰ê·  ê³„ì‚°í•˜ê¸°</button>
    </div>
    <div class="avg-result" id="avgResult">
      <div class="avg-result-label">ì „ì²´ í‰ê· </div>
      <div class="avg-result-score" id="avgResultScore">0</div>
      <button class="avg-next-btn" style="margin-top:20px; background:#34c759;" onclick="resetAvgCalc()">ë‹¤ì‹œ ê³„ì‚°í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
// ========== NEIS API ì„¤ì • ==========
const MEAL_API_URL = 'https://open.neis.go.kr/hub/mealServiceDietInfo';
const SCHOOL_API_URL = 'https://open.neis.go.kr/hub/schoolInfo';
const NEIS_API_KEY = 'b960b906675e4d64a30ef65900737807';

let currentMealType = 'lunch';

// ========== ê¸‰ì‹ ê´€ë ¨ í•¨ìˆ˜ ==========

function getTodayDate() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}${month}${day}`;
}

function loadMealDate() {
  const today = new Date();
  const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const dateStr = `${today.getFullYear()}.${String(today.getMonth()+1).padStart(2,'0')}.${String(today.getDate()).padStart(2,'0')} (${days[today.getDay()]})`;
  document.getElementById('mealDate').textContent = dateStr;
}

function removeAllergyInfo(menuItem) {
  return menuItem
    .replace(/\([0-9.,\s]+\)/g, '')
    .replace(/[0-9.,\s]+$/g, '')
    .trim();
}

async function searchSchoolFromNEIS(schoolName) {
  try {
    const params = new URLSearchParams({
      KEY: NEIS_API_KEY,
      Type: 'json',
      pIndex: 1,
      pSize: 10,
      SCHUL_NM: schoolName
    });

    const response = await fetch(`${SCHOOL_API_URL}?${params}`);
    const data = await response.json();

    if (!data.schoolInfo || data.schoolInfo[0].head[0].RESULT.CODE !== 'INFO-000') {
      return [];
    }

    return data.schoolInfo[1].row.map(school => ({
      code: school.SD_SCHUL_CODE,
      name: school.SCHUL_NM,
      address: school.ORG_RDNMA,
      officeCode: school.ATPT_OFCDC_SC_CODE,
      schoolType: school.SCHUL_KND_SC_NM
    }));

  } catch (error) {
    console.error('í•™êµ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
    return [];
  }
}

async function getMealFromNEIS(officeCode, schoolCode, date) {
  try {
    const params = new URLSearchParams({
      KEY: NEIS_API_KEY,
      Type: 'json',
      pIndex: 1,
      pSize: 100,
      ATPT_OFCDC_SC_CODE: officeCode,
      SD_SCHUL_CODE: schoolCode,
      MLSV_YMD: date
    });

    const response = await fetch(`${MEAL_API_URL}?${params}`);
    const data = await response.json();

    if (!data.mealServiceDietInfo || data.mealServiceDietInfo[0].head[0].RESULT.CODE !== 'INFO-000') {
      return { breakfast: null, lunch: null, dinner: null };
    }

    const meals = data.mealServiceDietInfo[1].row;
    const result = { breakfast: null, lunch: null, dinner: null };

    meals.forEach(meal => {
      const menuItems = meal.DDISH_NM
        .split('<br/>')
        .map(item => removeAllergyInfo(item.trim()))
        .filter(item => item.length > 0);

      const mealType = meal.MMEAL_SC_NM;

      if (mealType === 'ì¡°ì‹') result.breakfast = menuItems;
      else if (mealType === 'ì¤‘ì‹') result.lunch = menuItems;
      else if (mealType === 'ì„ì‹') result.dinner = menuItems;
    });

    return result;

  } catch (error) {
    console.error('ê¸‰ì‹ ì¡°íšŒ ì˜¤ë¥˜:', error);
    return { breakfast: null, lunch: null, dinner: null };
  }
}

function changeMealType(type) {
  currentMealType = type;
  document.querySelectorAll('.meal-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`.meal-tab.${type}`).classList.add('active');
  loadMealData();
}

async function loadMealData() {
  const school = JSON.parse(localStorage.getItem('selectedSchool') || 'null');
  const mealContent = document.getElementById('mealContent');
  
  if (!school) {
    mealContent.innerHTML = '<div class="meal-empty">âš™ï¸ ì„¤ì •ì—ì„œ í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>';
    return;
  }
  
  mealContent.innerHTML = '<div class="meal-loading">ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  
  try {
    const todayDate = getTodayDate();
    const meals = await getMealFromNEIS(school.officeCode, school.code, todayDate);
    
    const mealTypeMap = {
      'breakfast': meals.breakfast,
      'lunch': meals.lunch,
      'dinner': meals.dinner
    };
    
    displayMealMenu(mealTypeMap[currentMealType]);
    
  } catch (error) {
    console.error('ê¸‰ì‹ ë¡œë“œ ì˜¤ë¥˜:', error);
    mealContent.innerHTML = '<div class="meal-empty">ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
  }
}

function displayMealMenu(menuItems) {
  const mealContent = document.getElementById('mealContent');
  
  if (!menuItems || menuItems.length === 0) {
    mealContent.innerHTML = '<div class="meal-empty">ê¸‰ì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  let html = '<div class="meal-menu">';
  menuItems.forEach(item => {
    if (item) {
      html += `<div class="meal-menu-item">â€¢ ${item}</div>`;
    }
  });
  html += '</div>';
  
  html += `
    <div class="meal-allergy">
      âš ï¸ ì•Œë ˆë¥´ê¸° ì •ë³´ëŠ” í•™êµ ê¸‰ì‹ì‹¤ ë˜ëŠ” ë‹´ë‹¹ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.
    </div>
  `;
  
  mealContent.innerHTML = html;
}

async function searchSchool() {
  const query = document.getElementById('schoolSearch').value.trim();
  const resultsDiv = document.getElementById('schoolResults');
  
  if (query.length < 2) {
    resultsDiv.innerHTML = '';
    return;
  }
  
  resultsDiv.innerHTML = '<div class="meal-loading">ê²€ìƒ‰ ì¤‘...</div>';
  
  const schools = await searchSchoolFromNEIS(query);
  
  if (schools.length === 0) {
    resultsDiv.innerHTML = '<div class="meal-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  let html = '';
  schools.forEach(school => {
    html += `
      <div class="school-item" onclick='selectSchool(${JSON.stringify(school)})'>
        <div class="school-name">${school.name} (${school.schoolType})</div>
        <div class="school-address">${school.address}</div>
      </div>
    `;
  });
  
  resultsDiv.innerHTML = html;
}

function selectSchool(school) {
  localStorage.setItem('selectedSchool', JSON.stringify(school));
  document.getElementById('schoolSearch').value = '';
  document.getElementById('schoolResults').innerHTML = '';
  loadCurrentSchool();
  loadMealData();
  alert(`${school.name}ì´(ê°€) ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

function loadCurrentSchool() {
  const school = JSON.parse(localStorage.getItem('selectedSchool') || 'null');
  const display = document.getElementById('currentSchoolDisplay');
  
  if (school) {
    display.querySelector('.current-school-name').textContent = school.name;
  } else {
    display.querySelector('.current-school-name').textContent = 'í•™êµë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”';
  }
}

function openMealSettings() {
  document.getElementById('mealSettingsModal').style.display = 'flex';
  loadCurrentSchool();
  loadNotificationTimes();
}

function closeMealSettings() {
  document.getElementById('mealSettingsModal').style.display = 'none';
}

function loadNotificationTimes() {
  const times = JSON.parse(localStorage.getItem('mealNotificationTimes') || '{"breakfast":"08:00","lunch":"12:30","dinner":"18:00"}');
  document.getElementById('breakfastTime').value = times.breakfast;
  document.getElementById('lunchTime').value = times.lunch;
  document.getElementById('dinnerTime').value = times.dinner;
}

function saveMealSettings() {
  const times = {
    breakfast: document.getElementById('breakfastTime').value,
    lunch: document.getElementById('lunchTime').value,
    dinner: document.getElementById('dinnerTime').value
  };
  
  localStorage.setItem('mealNotificationTimes', JSON.stringify(times));
  
  if (localStorage.getItem('mealNotificationEnabled') === 'true') {
    scheduleMealNotifications();
  }
  
  closeMealSettings();
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function toggleNotification() {
  const switchEl = document.getElementById('notificationSwitch');
  const isEnabled = switchEl.classList.contains('on');
  
  if (!isEnabled) {
    requestNotificationPermission();
  } else {
    switchEl.classList.remove('on');
    localStorage.setItem('mealNotificationEnabled', 'false');
  }
}

async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  
  const permission = await Notification.requestPermission();
  
  if (permission === 'granted') {
    document.getElementById('notificationSwitch').classList.add('on');
    localStorage.setItem('mealNotificationEnabled', 'true');
    scheduleMealNotifications();
    alert('ê¸‰ì‹ ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
  } else {
    alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

function scheduleMealNotifications() {
  setInterval(checkMealTime, 60000);
}

function checkMealTime() {
  const now = new Date();
  const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const times = JSON.parse(localStorage.getItem('mealNotificationTimes') || '{"breakfast":"08:00","lunch":"12:30","dinner":"18:00"}');
  
  if (localStorage.getItem('mealNotificationEnabled') !== 'true') return;
  
  const mealTypes = { breakfast: 'ì¡°ì‹', lunch: 'ì¤‘ì‹', dinner: 'ì„ì‹' };
  
  Object.entries(times).forEach(([type, time]) => {
    if (time === currentTime) {
      showMealNotification(type, mealTypes[type]);
    }
  });
}

async function showMealNotification(type, typeName) {
  const school = JSON.parse(localStorage.getItem('selectedSchool') || 'null');
  
  if (!school) return;
  
  const todayDate = getTodayDate();
  const meals = await getMealFromNEIS(school.officeCode, school.code, todayDate);
  const menu = meals[type];
  
  if ('Notification' in window && Notification.permission === 'granted' && menu && menu.length > 0) {
    const menuText = menu.slice(0, 3).join(', ') + (menu.length > 3 ? '...' : '');
    new Notification(`ğŸ½ï¸ ${typeName} ì‹œê°„ì…ë‹ˆë‹¤!`, {
      body: `ì˜¤ëŠ˜ì˜ ë©”ë‰´: ${menuText}`,
      icon: 'icon-192.png',
      badge: 'icon-192.png'
    });
  }
}

// ========== ì„±ì  ê³„ì‚°ê¸° ì½”ë“œ ==========

const defaultSubjects = [
  { name: 'ìë£Œêµ¬ì¡°', sCount: 2, tCount: 2, sWeights: [30,30], tWeights: [20,20] },
  { name: 'ì˜ì–´', sCount: 2, tCount: 1, sWeights: [20,30], tWeights: [50] },
  { name: 'ê¸°ê³„', sCount: 2, tCount: 2, sWeights: [30,30], tWeights: [20,20] },
  { name: 'ìë™í™”ì„¤ë¹„', sCount: 2, tCount: 2, sWeights: [30,30], tWeights: [20,20] },
  { name: 'ì „ìíšŒë¡œ', sCount: 2, tCount: 2, sWeights: [30,30], tWeights: [20,20] },
  { name: 'ì „ê¸°íšŒë¡œ', sCount: 2, tCount: 2, sWeights: [25,25], tWeights: [20,30] },
  { name: 'êµ­ì–´', sCount: 2, tCount: 1, sWeights: [20,30], tWeights: [50] },
  { name: 'ê³µí†µì‚¬íšŒ1', sCount: 2, tCount: 1, sWeights: [30,30], tWeights: [40] }
];

function loadSubjects() {
  const saved = localStorage.getItem('customSubjects');
  if(saved) {
    return JSON.parse(saved);
  }
  return [...defaultSubjects];
}

function saveSubjects(subjects) {
  localStorage.setItem('customSubjects', JSON.stringify(subjects));
}

function renderGuideTable() {
  const subjects = loadSubjects();
  const tbody = document.getElementById('guideTableBody');
  tbody.innerHTML = '';
  
  subjects.forEach((subj, idx) => {
    const sText = subj.sWeights.map((w, i) => `ìˆ˜í–‰${i+1} ${w}%`).join(', ');
    const tText = subj.tCount === 1 ? `ê¸°ë§ ${subj.tWeights[0]}%` : `ì¤‘ê°„ ${subj.tWeights[0]}%, ê¸°ë§ ${subj.tWeights[1]}%`;
    
    tbody.innerHTML += `
      <tr>
        <td class="guide-subject" onclick="applySubject('${subj.name}', ${subj.sCount}, ${subj.tCount}, [${subj.sWeights}], [${subj.tWeights}])">${subj.name}</td>
        <td onclick="applySubject('${subj.name}', ${subj.sCount}, ${subj.tCount}, [${subj.sWeights}], [${subj.tWeights}])">${sText}</td>
        <td onclick="applySubject('${subj.name}', ${subj.sCount}, ${subj.tCount}, [${subj.sWeights}], [${subj.tWeights}])">${tText}</td>
        <td><span class="delete-btn" onclick="deleteSubject(${idx})">ì‚­ì œ</span></td>
      </tr>
    `;
  });
}

function deleteSubject(idx) {
  if(!confirm('ì´ ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const subjects = loadSubjects();
  subjects.splice(idx, 1);
  saveSubjects(subjects);
  renderGuideTable();
}

function openAddSubject() {
  document.getElementById('addSubjectModal').style.display = 'flex';
  document.getElementById('newSubjectName').value = '';
  document.getElementById('newSCount').value = 2;
  document.getElementById('newTCount').value = 2;
  generateNewSubjectInputs();
}

function closeAddSubject() {
  document.getElementById('addSubjectModal').style.display = 'none';
}

function generateNewSubjectInputs() {
  const sCount = Number(document.getElementById('newSCount').value);
  const tCount = Number(document.getElementById('newTCount').value);
  
  let sHTML = '';
  for(let i = 0; i < sCount; i++) {
    sHTML += `
      <div class="entry" style="margin-bottom:10px;">
        <label>ìˆ˜í–‰${i+1} ë¹„ì¤‘ (%)</label>
        <input id="newSW${i}" type="number" placeholder="ì˜ˆ: 30" min="1" max="100">
      </div>
    `;
  }
  document.getElementById('newSWeightsContainer').innerHTML = sHTML;
  
  let tHTML = '';
  for(let i = 0; i < tCount; i++) {
    const lbl = tCount === 1 ? 'ê¸°ë§ê³ ì‚¬' : (i === 0 ? 'ì¤‘ê°„ê³ ì‚¬' : 'ê¸°ë§ê³ ì‚¬');
    tHTML += `
      <div class="entry" style="margin-bottom:10px;">
        <label>${lbl} ë¹„ì¤‘ (%)</label>
        <input id="newTW${i}" type="number" placeholder="ì˜ˆ: 20" min="1" max="100">
      </div>
    `;
  }
  document.getElementById('newTWeightsContainer').innerHTML = tHTML;
}

function saveNewSubject() {
  const name = document.getElementById('newSubjectName').value.trim();
  const sCount = Number(document.getElementById('newSCount').value);
  const tCount = Number(document.getElementById('newTCount').value);
  
  if(!name) {
    alert('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const sWeights = [];
  const tWeights = [];
  let totalWeight = 0;
  
  for(let i = 0; i < sCount; i++) {
    const w = Number(document.getElementById(`newSW${i}`).value);
    if(!w || w < 1) {
      alert('ëª¨ë“  ë¹„ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    sWeights.push(w);
    totalWeight += w;
  }
  
  for(let i = 0; i < tCount; i++) {
    const w = Number(document.getElementById(`newTW${i}`).value);
    if(!w || w < 1) {
      alert('ëª¨ë“  ë¹„ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    tWeights.push(w);
    totalWeight += w;
  }
  
  if(totalWeight !== 100) {
    alert(`ì´ ë¹„ì¤‘ì´ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: ${totalWeight}%)`);
    return;
  }
  
  const subjects = loadSubjects();
  subjects.push({ name, sCount, tCount, sWeights, tWeights });
  saveSubjects(subjects);
  renderGuideTable();
  closeAddSubject();
  alert(`${name} ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

const themeBtn = document.getElementById("themeToggle");
function applyTheme(t){
  document.body.dataset.theme = t;
  localStorage.setItem("theme", t);
}
applyTheme(localStorage.getItem("theme") || "light");
themeBtn.onclick = () => applyTheme(document.body.dataset.theme==="dark" ? "light" : "dark");

function makeWeightButtons(id){
  const values=[20,25,30,40,50];
  return `
    <div class="weight-select">
      ${values.map(v => `<div class="weight-btn" onclick="selectWeight('${id}', ${v}, this)">${v}%</div>`).join("")}
      <div class="weight-btn custom-btn" onclick="openCustom('${id}', this)">+</div>
    </div>
    <div id="${id}-custom" class="custom-weight-container">
      <input type="number" id="${id}-manual" class="custom-weight-input" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: 35)">
      <button class="weight-set-btn" onclick="applyCustom('${id}')">í™•ì¸</button>
    </div>
  `;
}

function selectWeight(id, val, el){
  document.getElementById(id).value = val;
  el.parentNode.querySelectorAll(".weight-btn").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
  document.getElementById(id+"-custom").style.display="none";
}

function openCustom(id, el){
  const cont = document.getElementById(id+"-custom");
  cont.style.display="flex";
  el.parentNode.querySelectorAll(".weight-btn").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
}

function applyCustom(id){
  const val = Number(document.getElementById(id+"-manual").value);
  if(!val || val<1 || val>100){
    alert("1~100 ì‚¬ì´ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  document.getElementById(id).value = val;
  document.getElementById(id+"-custom").style.display="none";
  const parent = document.getElementById(id+"-custom").previousElementSibling;
  parent.querySelector(".custom-btn").classList.add("active");
}

function generateInputs(){
  const sCnt = Number(document.getElementById("sCount").value);
  const tCnt = Number(document.getElementById("tCount").value);

  let sHTML = `<div class="section-title">ìˆ˜í–‰í‰ê°€</div>`;
  for(let i=0;i<sCnt;i++){
    sHTML += `
      <div class="entry">
        <label>ìˆ˜í–‰ ${i+1} ì ìˆ˜</label>
        <input id="s${i}" type="number">
        <label style="margin-top:10px;">ë¹„ì¤‘</label>
        <input id="sw${i}" type="number" style="display:none;">
        ${makeWeightButtons(`sw${i}`)}
      </div>
    `;
  }

  let eHTML = `<div class="section-title">ì§€í•„í‰ê°€</div>`;
  for(let i=0;i<tCnt;i++){
    const lbl = tCnt===1 ? "ê¸°ë§ê³ ì‚¬" : i===0 ? "ì¤‘ê°„ê³ ì‚¬" : "ê¸°ë§ê³ ì‚¬";
    eHTML += `
      <div class="entry">
        <label>${lbl} ì ìˆ˜</label>
        <input id="t${i}" type="number">
        <label style="margin-top:10px;">ë¹„ì¤‘</label>
        <input id="tw${i}" type="number" style="display:none;">
        ${makeWeightButtons(`tw${i}`)}
      </div>
    `;
  }

  document.getElementById("performBox").innerHTML = sHTML;
  document.getElementById("examBox").innerHTML = eHTML;
}
generateInputs();

function calculate(){
  const sCnt = Number(sCount.value);
  const tCnt = Number(tCount.value);
  let total=0, wSum=0, finalW=0;
  const subj = subjectName.value.trim() || "-";

  for(let i=0;i<sCnt;i++){
    const score = Number(document.getElementById(`s${i}`).value) || 0;
    const w = Number(document.getElementById(`sw${i}`).value) || 0;
    total += score*(w/100);
    wSum += w;
  }

  let finalScore = 0;
  for(let i=0;i<tCnt;i++){
    const score = Number(document.getElementById(`t${i}`).value) || 0;
    const w = Number(document.getElementById(`tw${i}`).value) || 0;
    if(tCnt===1 || i===tCnt-1) {
      finalW = w/100;
      finalScore = score;
    }
    total += score*(w/100);
    wSum += w;
  }

  if(wSum !== 100){
    result.innerHTML = `ì´ ë¹„ì¤‘ì´ 100%ê°€ ì•„ë‹™ë‹ˆë‹¤. (${wSum}%)`;
    return;
  }

  total = Number(total.toFixed(2));
  const grade = total>=90?"A": total>=80?"B": total>=70?"C": total>=60?"D":"E";
  const nextCut = {A:null, B:90, C:80, D:70, E:60}[grade];
  const currCut = {A:90, B:80, C:70, D:60, E:0}[grade];

  let nextMsg = "ìµœê³  ë“±ê¸‰!";
  if(total === 100){
    nextMsg = "ë§Œì !";
  } else if(nextCut){
    const need = (nextCut - (total - finalScore*finalW)) / finalW;
    nextMsg = need>100 ? "ë¶ˆê°€ëŠ¥" : `${need.toFixed(2)}ì â†‘`;
  }

  const drop = (currCut - 0.01 - (total - finalScore*finalW)) / finalW;
  const dropMsg = drop<0 ? "ë–¨ì–´ì§ˆ ë“±ê¸‰ ì—†ìŒ" : `${drop.toFixed(2)}ì â†“`;

  let predictionHTML = "";
  if(finalScore !== 100) {
    const totalWithoutFinal = total - finalScore * finalW;
    const predictedTotal = Number((totalWithoutFinal + 100 * finalW).toFixed(2));
    const predictedGrade = predictedTotal>=90?"A": predictedTotal>=80?"B": predictedTotal>=70?"C": predictedTotal>=60?"D":"E";
    
    predictionHTML = `
      <div class="prediction-box">
        <div class="prediction-title">ê¸°ë§ê³ ì‚¬ 100ì ì´ë©´</div>
        <div>ì˜ˆìƒ ì ìˆ˜: <b>${predictedTotal}</b>ì </div>
        <div>ì˜ˆìƒ ë“±ê¸‰: <b class="grade-${predictedGrade}">${predictedGrade}</b></div>
      </div>
    `;
  }

  result.innerHTML = `
    ìµœì¢… ì ìˆ˜: <b>${total}</b>ì ${total === 100 ? ' (ë§Œì !)' : ''}<br>
    ë“±ê¸‰: <b class="grade-${grade}">${grade}</b>${total === 100 ? ' (ë§Œì !)' : ''}<br>
    ì˜¬ë¼ê°ˆ ê¸°ì¤€: ${nextMsg}<br>
    ë–¨ì–´ì§ˆ ê¸°ì¤€: ${dropMsg}
    ${predictionHTML}
  `;

  saveHistory({time: nowTime(), subject: subj, final: total, grade: grade, nextMsg, dropMsg});
  renderHistory();
}

function nowTime(){
  const d = new Date();
  return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function loadHistory(){
  return JSON.parse(localStorage.getItem("gradeHistory")||"[]");
}

function saveHistory(e){
  const h=loadHistory();
  h.unshift(e);
  localStorage.setItem("gradeHistory", JSON.stringify(h.slice(0,50)));
}

function resetHistory(){
  if(confirm("ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
    localStorage.removeItem("gradeHistory");
    renderHistory();
  }
}

function renderHistory(){
  const tb=document.getElementById("historyBody");
  tb.innerHTML="";
  loadHistory().forEach((e,i)=>{
    tb.innerHTML += `
      <tr>
        <td>${e.time}</td>
        <td class="subject">${e.subject}</td>
        <td>${e.final}</td>
        <td><b class="grade-${e.grade}">${e.grade}</b></td>
        <td>${e.nextMsg}</td>
        <td>${e.dropMsg}</td>
        <td><span class="delete-btn" onclick="deleteHistory(${i})">ì‚­ì œ</span></td>
        <td><button class="info-btn" onclick="openInfo(${i})">ì •ë³´</button></td>
      </tr>
    `;
  });
}
renderHistory();

function deleteHistory(i){
  const h=loadHistory();
  h.splice(i,1);
  localStorage.setItem("gradeHistory", JSON.stringify(h));
  renderHistory();
}

function openInfo(i){
  const e=loadHistory()[i];
  const modal=document.getElementById("detailModal");
  const inner=document.getElementById("modalInner");
  inner.innerHTML = `
    <h3>${e.subject}</h3>
    <p style="margin-top:10px;">ìµœì¢…ì ìˆ˜: <b>${e.final}</b></p>
    <p>ë“±ê¸‰: <b class="grade-${e.grade}">${e.grade}</b></p>
    <p>ì˜¬ë¼ê°ˆ ê¸°ì¤€: ${e.nextMsg}</p>
    <p>ë–¨ì–´ì§ˆ ê¸°ì¤€: ${e.dropMsg}</p>
  `;
  modal.style.display="flex";
}

function closeModal(){
  document.getElementById("detailModal").style.display="none";
}

window.onclick = e => {
  if(e.target.id === "detailModal") closeModal();
  if(e.target.id === "guideModal") closeGuide();
  if(e.target.id === "avgModal") closeAvgCalc();
  if(e.target.id === "addSubjectModal") closeAddSubject();
  if(e.target.id === "mealSettingsModal") closeMealSettings();
};

function openGuide(){
  document.getElementById("guideModal").style.display="flex";
}

function closeGuide(){
  document.getElementById("guideModal").style.display="none";
}

function applySubject(name, sCount, tCount, sWeights, tWeights){
  document.getElementById("subjectName").value = name;
  document.getElementById("sCount").value = sCount;
  document.getElementById("tCount").value = tCount;
  generateInputs();
  
  setTimeout(() => {
    for(let i=0; i<sCount; i++){
      const scoreInput = document.getElementById(`s${i}`);
      const weightInput = document.getElementById(`sw${i}`);
      if(scoreInput) scoreInput.placeholder = "ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
      if(weightInput) {
        weightInput.value = sWeights[i];
        const btns = weightInput.nextElementSibling.querySelectorAll(".weight-btn");
        btns.forEach(btn => {
          if(btn.textContent.trim() === sWeights[i] + "%") btn.classList.add("active");
        });
      }
    }
    for(let i=0; i<tCount; i++){
      const scoreInput = document.getElementById(`t${i}`);
      const weightInput = document.getElementById(`tw${i}`);
      if(scoreInput) scoreInput.placeholder = "ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
      if(weightInput) {
        weightInput.value = tWeights[i];
        const btns = weightInput.nextElementSibling.querySelectorAll(".weight-btn");
        btns.forEach(btn => {
          if(btn.textContent.trim() === tWeights[i] + "%") btn.classList.add("active");
        });
      }
    }
  }, 100);
  
  closeGuide();
  alert(`${name} ê³¼ëª©ì˜ ë¹„ì¤‘ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

const stars = document.querySelectorAll('.star');
const ratingResult = document.getElementById('ratingResult');

stars.forEach(star => {
  star.addEventListener('mouseenter', function() {
    highlightStars(this.dataset.value);
  });
});

document.querySelector('.star-rating').addEventListener('mouseleave', function() {
  const saved = getRating();
  saved ? highlightStars(saved) : clearStars();
});

stars.forEach(star => {
  star.addEventListener('click', function() {
    const val = this.dataset.value;
    saveRating(val);
    highlightStars(val);
    ratingResult.textContent = `í‰ê°€í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! (${val}ì )`;
    ratingResult.style.color = '#34c759';
  });
});

function highlightStars(count) {
  stars.forEach((star, i) => {
    if(i < count) {
      star.textContent = 'â˜…';
      star.classList.add('active');
    } else {
      star.textContent = 'â˜†';
      star.classList.remove('active');
    }
  });
}

function clearStars() {
  stars.forEach(star => {
    star.textContent = 'â˜†';
    star.classList.remove('active');
  });
}

function saveRating(val) {
  localStorage.setItem('userRating', val);
}

function getRating() {
  return localStorage.getItem('userRating');
}

function openAvgCalc() {
  document.getElementById("avgModal").style.display = "flex";
  resetAvgCalc();
}

function closeAvgCalc() {
  document.getElementById("avgModal").style.display = "none";
}

function resetAvgCalc() {
  document.getElementById("avgStep1").style.display = "block";
  document.getElementById("avgStep2").style.display = "none";
  document.getElementById("avgResult").style.display = "none";
  document.getElementById("avgSubjectCount").value = "";
  document.getElementById("avgSubjectsList").innerHTML = "";
}

function handleAvgCountEnter(event) {
  if(event.key === "Enter") {
    event.preventDefault();
    generateAvgSubjects();
  }
}

function handleScoreEnter(event, index, total) {
  if(event.key === "Enter") {
    event.preventDefault();
    if(index < total - 1) {
      document.getElementById(`avgScore${index + 1}`).focus();
    } else {
      calculateAvg();
    }
  }
}

function generateAvgSubjects() {
  const count = Number(document.getElementById("avgSubjectCount").value);
  
  if(!count || count < 1 || count > 20) {
    alert("1~20 ì‚¬ì´ì˜ ê³¼ëª© ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  let html = "";
  for(let i = 0; i < count; i++) {
    html += `
      <div class="avg-subject-row">
        <input type="number" class="subject-score" id="avgScore${i}" placeholder="ì ìˆ˜ ${i+1}" min="0" max="100" onkeydown="handleScoreEnter(event, ${i}, ${count})">
      </div>
    `;
  }
  
  document.getElementById("avgSubjectsList").innerHTML = html;
  document.getElementById("avgStep1").style.display = "none";
  document.getElementById("avgStep2").style.display = "block";
  
  setTimeout(() => {
    document.getElementById("avgScore0").focus();
  }, 100);
}

function calculateAvg() {
  const count = Number(document.getElementById("avgSubjectCount").value);
  let totalScore = 0;
  let validCount = 0;
  
  for(let i = 0; i < count; i++) {
    const score = Number(document.getElementById(`avgScore${i}`).value);
    
    if(!isNaN(score) && score >= 0) {
      totalScore += score;
      validCount++;
    }
  }
  
  if(validCount === 0) {
    alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  const average = (totalScore / validCount).toFixed(2);
  
  document.getElementById("avgResultScore").textContent = average;
  document.getElementById("avgStep2").style.display = "none";
  document.getElementById("avgResult").style.display = "block";
}

let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  const banner = document.getElementById('installBanner');
  const dismissed = localStorage.getItem('installBannerDismissed');
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  
  if (!dismissed && !isStandalone) {
    banner.classList.add('show');
  }
}

function closeInstallBanner() {
  document.getElementById('installBanner').classList.remove('show');
  localStorage.setItem('installBannerDismissed', 'true');
}

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        closeInstallBanner();
      }
      deferredPrompt = null;
    });
  } else {
    alert('í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë ¤ë©´:\n\n1. í•˜ë‹¨ì˜ ê³µìœ  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”\n2. "í™ˆ í™”ë©´ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”');
    closeInstallBanner();
  }
}

window.addEventListener('load', () => {
  loadMealDate();
  loadMealData();
  
  if (localStorage.getItem('mealNotificationEnabled') === 'true') {
    document.getElementById('notificationSwitch').classList.add('on');
    scheduleMealNotifications();
  }
  
  renderGuideTable();
  
  const saved = getRating();
  if(saved) {
    highlightStars(saved);
    ratingResult.textContent = `í‰ê°€í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! (${saved}ì )`;
    ratingResult.style.color = '#34c759';
  }
  
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone;
  const dismissed = localStorage.getItem('installBannerDismissed');
  
  if (isIOS && !isStandalone && !dismissed) {
    document.getElementById('installBanner').classList.add('show');
  }
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>

</body>
</html>
